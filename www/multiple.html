<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    
    <title>Modhunter - Multiple AGIs</title>

    <link rel="stylesheet" type="text/css" href="css/no-theme/jquery-ui-1.7.2.custom.css"/>
    <link rel="shortcut icon" href="img/modhunter.ico" />
    <script type="text/javascript">
    window.svgns = 'http://www.w3.org/2000/svg';
    </script>
    
    <script type="text/javascript" src="js/mascp-jstools.min.js"></script>
    <script type="text/javascript">
      // We should try to load data from the local server.
      MASCP.LOCALSERVER = true;
    </script>
    
    <script type="text/javascript" charset="utf-8" src="http://code.jquery.com/jquery-1.4.1.js"></script>

    <script type="text/javascript" src="js/jquery-ui-1.7.2.min.js"></script>
    <!-- <script type="text/javascript" src="js/jquery.masonry.min.js"></script> -->

    <script type="text/javascript" src="js/gator-conf.js"></script>
    <script type="text/javascript" src="js/gator-multiple.js"></script>
    <!--
    <script type="text/javascript" src="js/filetojson.js"></script> -->
    

    <script type="text/javascript">
    /*
    *jQuery table2csv plugin 0.1.0
    *Converts table html element to csv string
    *Copyright (c) 2009 Leonardo Rossetti motw.leo@gmail.com
    * Licensed under the MIT license (http://www.opensource.org/licenses/mit-license.php)
    *THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    *IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    *FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    *AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    *LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    *OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
    *THE SOFTWARE.
    */
    //keeps closure
        var table2CSV = function (options) {
            var defaults = {
                delimiter: ",",
                callback: function (csv) {
                    return csv;
                }
            };
            var settings = jQuery.extend(defaults, options);

            return (function () {
                var csv = "";
                //gets th to set column headers
                jQuery(this).find("thead tr th").each(function() {
                    csv += "\"" + jQuery(this).text().replace(/(\")/gim, "\\\"\\\"") + "\"" + settings.delimiter; 
                });
                csv += "\n";
                //each td as a csv column
                jQuery(this).find("tbody tr").each(function () {
                    jQuery(this).find("td").each(function () {
                        csv += "\"" + jQuery(this).text().replace(/(\")/gim, "\\\"\\\"") + "\"" + settings.delimiter;
                    });
                    csv += "\n";
                });
                //callback function containing csv string as parameter
                settings.callback(csv);
                return csv;
            }).call(this);
        };
    </script>

    <style type="text/css">

        .screen {
            background:#000000 none repeat scroll 0 0;
            display:none;
            height:100%;
            left:0;
            filter:alpha(opacity=80);
            opacity: 0.8;
            top:0;
            width:100%;
            z-index:50;
            display:none;
            position:fixed;
        }


        html {
            min-width: 800px;
            height: 100%;
        }

        body {
            font-family: Verdana, Helvetica, Arial, sans-serif;
            font-size: 10px;
            height: 100%;
        }
        h1 span {
            display: block;
            position: absolute;
            top: 0px;
            left: 0px;
        }
        
        h3 {
            font-size: 32px;
        }


        .rounded_box {
            background: #eeeeee;
            -moz-border-radius: 5px;
            border-radius: 5px;
            padding-right: 5px;
            padding-bottom: 5px;
        }

        .rounded_box * {
            margin-left: 5px;
        }


        .rounded_box .inset {
            -moz-border-radius: 5px 0px 5px 0px;
            border-bottom-right-radius: 5px;
            border-top-left-radius: 5px;
            padding: 5px;
            background: #888888;
            color: #eeeeee;
            margin: 0px;
            overflow: hidden;
            display: block;
            width: 170px;
        }

        #agi_display {
            overflow: auto;
        }
        #agi_input {
            position: absolute;
            top: 10px;
            bottom: 110px;
            width: 200px;
        }
        #agi_input, #agi_input input[type='text'] {
            font-size: 12px;
        }
        #agi_input input[type='text'] {
            font-size: 20px;
            border: solid #ffffff 1px;
            margin-top: 1px;
            height: 20px;
            width: 50px;
        }

        #agi_list {
            position: absolute;
            width: 200px;
            top: 55px;
            bottom: 0px;
            margin-bottom: 30px;
        }
        #agi {
            position: absolute;
            top: 10px;
            bottom: 30px;
            height: 100%;
            width: 160px;
            resize: none;
        }
        
        #agi_edit, #agi_display {
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
        }
        #help_container {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 200px;
            height: 80px;
        }
        #results th {
            background: rgb(100,100,100);
            color: rgb(255,255,255);
            padding: 2px;
        }
        #results tr {
            background: rgb(240,240,240);
        }
        #results tr.odd {
            background: rgb(230,230,230);
        }

        span.fatal, span.errors, span.success {
            width: 10px;
            padding-right: 10px;
            height: 10px;            
        }
        
        span.fatal {
            background: rgb(255,0,0);
        }
        
        span.errors {
            background: rgb(250,150,20);            
        }

        span.success {
            background: rgb(0,255,0);            
        }
        
    </style>
</head>

<body>
<!--
<div style="position: absolute; top: 10px; left: 10px; width: 25%; display: none;">
    <h1 style="position: absolute; left: 0px; top: 0px; margin: 0px; width: 100%; font-size: 10px; "><span>MASCP AggreGATOR</span><img style="height: 50px; top: 50%; left: -7px; position: absolute;" src="gator.png" /></h1>
</div>
<a style="display: block; position: absolute; top: 10px; left: 10px; width: 90px; height: 68px; background-image: url(http://www.masc-proteomics.org/mascp/skins/common/images/mascp_logo.png);" href="http://www.masc-proteomics.org/" title="MASC Proteomics portal"></a>
-->

<div id="agi_input" class="rounded_box" style="">
    <label class="inset" for="min_mod_score">Minimum Mod Score (1-100)
        <input id="min_mod_score" type="text" name="min_mod_score" id="min_mod_score" value="50" />
        <input id="update_button" name="update_button" type="button" value="Update" />
    </label>
    <div id="agi_list">
        <div id="agi_edit">
            <textarea id="agi" type="text" name="agi">At1g29720.1
At1g57700.1
At1g73500.1
At1g73460.1
At1g73450.1
</textarea>
        </div>
    </div>
</div>

<div id="help_container" class="rounded_box">
    <div class="inset">Help</div>
    <div id="help">
        <p>
            <a href="http://www.masc-proteomics.org/mascp/index.php/Gator">Help</a>
        </p>
        <p>
            <a href="http://gator.masc-proteomics.org/source">Source</a>
        </p>
    </div>
</div>

<div style="margin-left: 220px;">
    <button id="save">Save as CSV</button>
    <ul style="font-size:16px">
        <div style="font-weight:bold">Possible modification regions:</div>
        <div id="status_field" style="font-style:italic"></div>
    </ul>
    <table id="results">
        <tr><th>AGI</th><th>Peptide Sequence</th><th>Residue Indeces</th><th>Mod Score</th><th>nsSNP Sites<br>(Modification unlikely)</th><th>Confirmed Modifications</th></tr>
    </table>
</div>
<script type="text/javascript">
//<[CDATA[ 
    window.onload = null;

    var save = function() {
        var generator = window.open('', 'csv', 'height=400,width=600'); 
          generator.document.write('<html><head><title>CSV Output</title>'); 
          generator.document.write('</head><body >'); 
          generator.document.write('<textArea cols=70 rows=15 wrap="off" >'); 
          generator.document.write(table2CSV.call(jQuery('#results'),({delivery:'value'}))); 
          generator.document.write('</textArea>'); 
          generator.document.write('</body></html>'); 
          generator.document.close();
          return true;
    };
    
    var showIESplash = function() {
        var splash = document.getElementById('ie_splash');
        splash.style.display = 'block';
        
        splash.hideForever = function() {
            var date = new Date();
            date.setTime(date.getTime()+(365*24*60*60*1000));
            var expires = "; expires="+date.toGMTString();
            document.cookie = 'iesplash=true'+expires+'; path=/';
            splash.style.display = 'none';
        };
        
        splash.hide = function() {
            splash.style.display = 'none';
        };
        
    };
    
    
    var mr = new MASCP.BatchRead();
    var mh = {};

    function unique(a)
    {
       var r = new Array();
       o:for(var i = 0, n = a.length; i < n; i++)
       {
          if (a[i].length > 0) {
              for(var x = 0, y = r.length; x < y; x++)
              {
                 if(r[x]==a[i]) continue o;
              }
              r[r.length] = a[i];
          }
       }
       return r;
    }

    function bind_agi_events() {
        jQuery('#update_button').bind('click',function() {
            rebuild_agi_display(unique((document.getElementById('agi').value || '').split(/\n/)));
        });
    }
    
    var odd = false;
    
    // Add a new row to output table for @agi, while @count indicates the number of rows for this AGI
    function add_agi_row(agi,count) {
        var agi_id = agi.replace(/\./, '|').toLowerCase();
        if (document.getElementById(agi_id)) {
            return;
        }
        var classthing = odd ? 'class="odd agirow"' : 'class="agirow"';
        odd = ! odd;
        jQuery('#results').append('<tr id="'+agi_id+count.toString()+'"'+classthing+'><td><a id="'+agi_id+count.toString()+'link" target="_blank" href="./#'+agi+'">'+agi+'</a></td><td class="pep_sequence"></td><td class="pep_indeces"></td><td class="mod_score"></td><td class="snp"></td><td class="mods"></td></tr>');
        if (count != 0) {
            document.getElementById(agi_id+count.toString()+'link').style.display = 'none';
        }
    }

    function rebuild_agi_display(vals) {
        jQuery('#status_field').text('Loading...');
        jQuery('#results tr.agirow').each(function(i) {
            this.parentNode.removeChild(this);
        });

        // mh is an object literal containing our modhunter objects for this collection of AGIs
        mh = {};
        var agiTotal = vals.length;
        var max_val = (vals.length > 50) ? 50 : vals.length;
        var agiCount = 0;
        var haveData = false;
        var minModScore = parseInt(jQuery('#min_mod_score').val());
        if (minModScore < 1 || minModScore > 100) {
            jQuery('#min_mod_score').val('50');
            minModScore = 50;
        }
        
        // grab_agis collects data for the AGIs given in @batch_vals, bound to agiComplete event if over 50 AGIs in @vals
        function grab_agis(batch_vals) {
            for (var i = 0; i < batch_vals.length; i++ ) {
                (function() {
                if (batch_vals[i].replace(/\s*/g,'') == '') {
                    return;
                }
                var new_els = jQuery('<div><span>'+batch_vals[i]+'</span><span class="status">Loading..</span><span class="messages"></span></div>')[0];
                new_els.status = jQuery('.status', new_els);
                new_els.agi = batch_vals[i];
                var agi_id = batch_vals[i].replace(/\./, '|').toLowerCase();
                var j = 1;
                var an_agi = new_els.agi;
                var error_count = 0;

                var newModhunter = new MASCP.Modhunter();
                newModhunter.displayCount = 0;

                // fire this when all modification data has been produced for the AGI associated with this modhunter object
                newModhunter.bind('agiComplete',function() {
                    var pepResults = [];
                    var snpList = [];
                    var leftIndex = 0;
                    var currScore = 0;
                    var errString = '';
                    var inPep = false;
                    var modsInPeps = {};
                    // getMods grabs confirmed modification sites within a specified index range
                    var getMods = function(lft, rt) {
                        var mods = [];
                        for (m = 0; m < this.confirmed_mods.length; m++) {
                            if (this.confirmed_mods[m][0] >= lft && this.confirmed_mods[m][0] <= rt) {
                                var modAdded = false;
                                for (var o = 0; o < mods.length; o++) {
                                    if (this.confirmed_mods[m][0] == mods[o][0] && this.confirmed_mods[m][1] == mods[o][1]) {
                                        modAdded = true;
                                    }
                                }
                                if (!modAdded) {
                                    mods.push(this.confirmed_mods[m]);
                                    modsInPeps[m] = true;
                                }
                            }
                        }
                        mods.sort(function(a,b) { return a[0]-b[0]; });
                        return mods;
                    }
                    if (this.whole_sequence) {
                        // scan protein sequence and produce regions meeting the minimum mod score
                        for (var j = 0; j < this.whole_sequence.length; j++) {
                            var k = j+1;
                            var minMet = (this.sequence[j].score >= minModScore);
                            var snpHere = (this.sequence[j].snp_coverage > 0);
                            if (this.sequence[j].score != currScore) {
                                if (currScore >= minModScore) {
                                    // pepResults contains the left index, right index, and mod score, and a list of nsSNP sites
                                    pepResults.push([leftIndex, j-1, currScore, snpList, getMods.call(this,leftIndex,j)]);
                                    // reset snpList
                                    snpList = [];
                                    if (minMet) {
                                        if (snpHere) {
                                            snpList.push(k);
                                        }
                                        inPep = true;
                                        leftIndex = j;
                                    } else {
                                        inPep = false;
                                    }
                                } else if (minMet) {
                                    if (snpHere) {
                                        snpList.push(k);
                                    }
                                    inPep = true;
                                    leftIndex = j;
                                }
                                currScore = this.sequence[j].score;
                            } else if (j == this.whole_sequence.length-1 && currScore >= minModScore) {
                                if (snpHere) {
                                    snpList.push(k);
                                }
                                pepResults.push([leftIndex, j, currScore, snpList, getMods.call(this,leftIndex,j)]);
                            } else if (snpHere && inPep) {
                                snpList.push(k);
                            }
                        }
                    }
                    
                    // now populate the table with retrieved results
                    var lastIdx = 0;
                    for (var k in pepResults) {
                        var agiRow = agi_id + this.displayCount.toString();
                        var modStr = '';
                        if (pepResults[k][0] > lastIdx) {
                            var gapMods = getMods.call(this,lastIdx,pepResults[k][0]-1);
                            if (gapMods.length > 0) {
                                add_agi_row(an_agi,this.displayCount);
                                while(gapMods.length > 0) {
                                    var newLoneMod = gapMods.shift();
                                    modStr += '<br>'+this.whole_sequence.charAt(newLoneMod[0])+' '+(newLoneMod[0]+1)+': '+newLoneMod[1];
                                }
                                modStr = modStr.slice(4);
                                jQuery('.mods', document.getElementById(agiRow)).html(modStr);
                                modStr = '';
                                this.displayCount++;
                                agiRow = agi_id + this.displayCount.toString();
                            }
                        }
                        lastIdx = pepResults[k][1]+1;
                        haveData = true;
                        add_agi_row(an_agi,this.displayCount);
                        var seqLength = pepResults[k][1]-pepResults[k][0]+1;
                        var seqStr = (seqLength > 10) ? '...' : '';
                        var snpStr = pepResults[k][3].toString().replace(/,/g,'; ');
                        jQuery('.pep_sequence', document.getElementById(agiRow)).html(this.whole_sequence.slice(pepResults[k][0],pepResults[k][0]+Math.min(seqLength,10)) + seqStr);
                        jQuery('.pep_indeces', document.getElementById(agiRow)).html((pepResults[k][0]+1) + ' - ' + (pepResults[k][1]+1));
                        jQuery('.mod_score', document.getElementById(agiRow)).html(pepResults[k][2]);
                        jQuery('.snp', document.getElementById(agiRow)).html(snpStr);
                        // construct a string from the confirmed modification sites
                        for (var n = 0; n < pepResults[k][4].length; n++) {
                            modStr += '<br>'+this.whole_sequence.charAt(pepResults[k][4][n][0])+' '+(pepResults[k][4][n][0]+1)+': '+pepResults[k][4][n][1];
                        }
                        modStr = modStr.slice(4);
                        jQuery('.mods', document.getElementById(agiRow)).html(modStr);
                        this.displayCount++;
                    }
                    if (lastIdx < this.whole_sequence.length-1) {
                        var agiRow = agi_id + this.displayCount.toString();
                        var modStr = '';
                        var gapMods = getMods.call(this,lastIdx,this.whole_sequence.length-1);
                        if (gapMods.length > 0) {
                            add_agi_row(an_agi,this.displayCount);
                            while(gapMods.length > 0) {
                                var newLoneMod = gapMods.shift();
                                modStr += '<br>'+this.whole_sequence.charAt(newLoneMod[0])+' '+(newLoneMod[0]+1)+': '+newLoneMod[1];
                            }
                            modStr = modStr.slice(4);
                            jQuery('.mods', document.getElementById(agiRow)).html(modStr);
                        }
                    }


                    // increment the number of AGIs retrieved, check if we're done or if it's time for a callback to grab_agis
                    agiCount++;
                    jQuery('#status_field').text(jQuery('#status_field').text().slice(0,11)+' '+agiCount.toString()+' / '+agiTotal.toString());
                    if (agiCount == agiTotal) {
                        jQuery('#status_field').text('');
                        if (haveData == false) {
                            jQuery('#status_field').text('No results found.');
                        }
                    } else if (agiCount % 50 == 0) {
                        var batchSize = (agiTotal - agiCount > 50) ? 50 : agiTotal - agiCount;
                        grab_agis(vals.slice(agiCount, agiCount + batchSize));
                    }
                });

                mh[batch_vals[i]] = newModhunter;
                
                mr.retrieve(batch_vals[i],mh[batch_vals[i]], {
                    'success' : function() {
                        if (error_count / j >= 0.5) {
                            jQuery('.status', new_els).html('<span class="fatal">&nbsp;</span>');
                        } else if (error_count > 0) {
                            jQuery('.status', new_els).html('<span class="errors">&nbsp;</span>');
                        } else {
                            jQuery('.status', new_els).html('<span class="success">&nbsp;</span>');
                        }
                    },
                    'error' : function() {
                        var classname = this.toString();
                        classname = classname.replace(/MASCP./,'');
                        classname = classname.replace(/Reader/,'');
                        error_count += 1;
                        jQuery('.messages', new_els).append(' '+classname+' ');
                        j += 1;
                    },
                    'single_success' : function() {
                        jQuery('.status', new_els).text('Retrieving data step '+j+' of '+mr._readers.length);
                        j += 1;
                    }
                });

                })();
            }
        }

        grab_agis(vals.slice(0, max_val));
    }
    
    jQuery(document).ready(function() {
        
        var supportsXHR = false;
        if (XMLHttpRequest)
        {
            var request = new XMLHttpRequest();
            if ("withCredentials" in request)
            {
                supportsXHR = true;
            }
        }
                
//        if (! document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure", "1.1") ||
        if (! supportsXHR ) {
//            MASCP.renderer = new MASCP.SequenceRenderer(document.getElementById('sequence_container'));
            if (document.cookie.indexOf('iesplash') < 0) {
                showIESplash();
            }
        } else {
//            MASCP.renderer = new MASCP.CondensedSequenceRenderer(document.getElementById('condensed_container'));
        }
        
        bind_agi_events();
        
        jQuery('#save').bind('click',save);
        
        if(!Array.indexOf){
            Array.prototype.indexOf = function(obj){
                for(var i=0; i<this.length; i++){
                    if(this[i]==obj){
                        return i;
                    }
                }
                return -1;
            }
        }
        
    });

    var change_func = function() {
        var agi = this.value;

        if (! agi.match(/\.\d$/)) {
            agi = agi + '.1';
        }
        
        if ( ! agi.match(/[aA].*\d+\.\d/)) {
            return;
        }
        
        this.value = agi;
        
        if (agi.length < 1) {
            return;
        }

        //add modal background
        if ( ! document._screen ) {
            document._screen = $('<div />').addClass('screen').appendTo('body');
        }
        document._screen.show();

        var reader = new MASCP.TairReader(agi);
        jQuery(reader).bind('resultReceived',function() {
            if (this.result.getSequence() == null || this.result.getSequence() == '') {
                document._screen.hide();
                return;
            }
        }).bind('error',function() {
            document._screen.hide();            
        });
        reader.retrieve();
    };

//]]>
</script>

<div id="ie_splash" style="display: none; background: #ffffff; border: solid black 2px; width: 50%; left: 25%; top: 5%; height: 80%; position: fixed; padding: 20px;">
    <h3>Browser compatibility</h3>
    <img src="img/condensed.png" style="width: 90%;"/>
    <p>Your current web browser cannot display interactive sequence information, and as such, a fallback technology has been used. The behaviour of the site may be sub-optimal. It is recommended to use a current browser such as <a href="http://www.getfirefox.net/">Firefox</a>, <a href="http://www.google.com/chrome">Google Chrome</a>, <a href="http://code.google.com/chrome/chromeframe/">Google Chrome frame</a> or <a href="http://apple.com/safari">Safari</a> to
        use this tool.
    </p>
    <button onclick="document.getElementById('ie_splash').hideForever();">Never show again</button>
    <button onclick="document.getElementById('ie_splash').hide();">Hide</button>
</div>

</body>
</html>
